<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saxophone Scale Visualizer</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-gold: #fbbf24;
            --accent-blue: #38bdf8;
            --key-inactive: #334155;
            --key-stroke: #475569;
            --border: #334155;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            overflow-y: auto;
        }

        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            min-height: 100vh;
        }

        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .sax-panel { order: -1; } /* Show sax on top on mobile */
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--accent-gold);
            letter-spacing: -0.5px;
        }

        h1 span { color: var(--accent-blue); }
        .subtitle { color: var(--text-muted); font-size: 0.9rem; margin-top: 0.2rem; }

        /* Controls */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            background: var(--bg-panel);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .control-group label {
            display: block;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        select, button {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:focus, button:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
        }

        /* Theory Display */
        .theory-card {
            background: linear-gradient(145deg, var(--bg-panel), #253349);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            text-align: center;
        }

        .key-display {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 1rem;
        }

        .key-item .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.2rem;
        }

        .key-item .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .key-item.concert .value { color: var(--accent-blue); }
        .key-item.written .value { color: var(--accent-gold); }

        .arrow { font-size: 1.5rem; color: var(--text-muted); opacity: 0.5; }

        .scale-formula {
            font-family: monospace;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem;
            border-radius: 4px;
            display: inline-block;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Note List */
        .note-list-container {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .note-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .note-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: var(--key-inactive);
            color: var(--text-muted);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .note-btn:hover {
            background: var(--key-stroke);
            transform: scale(1.1);
        }

        .note-btn.active {
            border-color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .note-btn.is-root.active {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        .note-btn.is-note.active {
            background: var(--accent-blue);
            color: var(--bg-dark);
        }

        .note-btn.is-root { border-color: var(--accent-gold); color: var(--accent-gold); background: transparent; }
        
        /* Playback Controls */
        .playback-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        .playback-controls button {
            flex: 1;
            background: var(--bg-dark);
            border-color: var(--border);
        }
        
        .playback-controls button:hover {
            background: var(--bg-panel);
            color: white;
        }

        /* Visualizer Panel */
        .sax-panel {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .sax-svg {
            height: 600px;
            width: 100%;
            max-width: 300px;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }

        /* SVG Styles */
        .sax-body { fill: none; stroke: #334155; stroke-width: 2; stroke-dasharray: 4,4; opacity: 0.5; }
        
        .key-shape {
            fill: var(--key-inactive);
            stroke: var(--key-stroke);
            stroke-width: 2px;
            transition: fill 0.15s ease, stroke 0.15s ease, filter 0.15s ease;
        }

        .key-shape.active-root {
            fill: var(--accent-gold);
            stroke: #fff;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
        }

        .key-shape.active-note {
            fill: var(--accent-blue);
            stroke: #fff;
            filter: drop-shadow(0 0 8px rgba(56, 189, 248, 0.6));
        }

        .key-label {
            fill: #64748b;
            font-size: 10px;
            font-weight: bold;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .current-note-display {
            position: absolute;
            top: 20px;
            right: 20px;
            text-align: right;
        }
        .current-note-name { font-size: 2.5rem; font-weight: bold; color: white; line-height: 1; }
        .current-note-octave { font-size: 1rem; color: var(--text-muted); }

    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>

<div class="container">
    
    <!-- Left Column: Logic & Controls -->
    <div class="logic-panel">
        <header>
            <div>
                <h1>SaxScale<span>Vis</span></h1>
                <div class="subtitle">Interactive Saxophone Scale Trainer</div>
            </div>
            <div style="text-align:right">
                <a href="#" style="color:var(--text-muted); text-decoration:none; font-size:0.8rem">v1.0</a>
            </div>
        </header>

        <div class="controls-grid">
            <div class="control-group">
                <label>Instrument</label>
                <select id="instrumentSelect">
                    <option value="ALTO">Alto Sax (Eb)</option>
                    <option value="TENOR">Tenor Sax (Bb)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Concert Key</label>
                <select id="concertKeySelect"></select>
            </div>
            <div class="control-group">
                <label>Scale Type</label>
                <select id="scaleTypeSelect">
                    <optgroup label="Basic Scales">
                        <option value="Major">Major</option>
                        <option value="Natural Minor">Natural Minor</option>
                        <option value="Harmonic Minor">Harmonic Minor</option>
                        <option value="Melodic Minor">Melodic Minor</option>
                    </optgroup>
                    <optgroup label="Pentatonic">
                        <option value="Major Pentatonic">Major Pentatonic</option>
                        <option value="Minor Pentatonic">Minor Pentatonic</option>
                        <option value="Dominant Pentatonic">Dominant Pentatonic</option>
                        <option value="Blues Scale">Blues Scale</option>
                    </optgroup>
                    <optgroup label="Modes">
                        <option value="Ionian">Ionian</option>
                        <option value="Dorian">Dorian</option>
                        <option value="Phrygian">Phrygian</option>
                        <option value="Lydian">Lydian</option>
                        <option value="Mixolydian">Mixolydian</option>
                        <option value="Aeolian">Aeolian</option>
                        <option value="Locrian">Locrian</option>
                    </optgroup>
                    <optgroup label="Advanced / Jazz">
                        <option value="Bebop Major">Bebop Major</option>
                        <option value="Bebop Dominant">Bebop Dominant</option>
                        <option value="Diminished (W-H)">Diminished (W-H)</option>
                        <option value="Diminished (H-W)">Diminished (H-W)</option>
                        <option value="Whole Tone">Whole Tone</option>
                        <option value="Altered">Altered Scale</option>
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="theory-card">
            <div class="key-display">
                <div class="key-item concert">
                    <div class="label">Concert Pitch</div>
                    <div class="value" id="concertKeyDisplay">C</div>
                </div>
                <div class="arrow">→</div>
                <div class="key-item written">
                    <div class="label">Written Pitch</div>
                    <div class="value" id="writtenKeyDisplay">A</div>
                </div>
            </div>
            <div class="scale-formula" id="scaleFormulaDisplay">1 2 3 4 5 6 7</div>
            <div style="margin-top:0.5rem; font-size:0.8rem; color:var(--text-muted)" id="transpositionHint">
                Alto Sax is Eb (Maj 6th up)
            </div>
        </div>

        <div class="note-list-container">
            <label style="display:block; color:var(--text-muted); font-size:0.8rem; font-weight:600; margin-bottom:10px; text-transform:uppercase;">Scale Notes (Written)</label>
            <div class="note-grid" id="noteGrid">
                <!-- Generated by JS -->
            </div>
            
            <div class="playback-controls">
                <button id="prevBtn">← Prev</button>
                <button id="playBtn">Play Scale</button>
                <button id="nextBtn">Next →</button>
            </div>
        </div>
    </div>

    <!-- Right Column: Visualizer -->
    <div class="sax-panel">
        <div class="current-note-display">
            <div class="current-note-name" id="displayNoteName">-</div>
            <div class="current-note-octave" id="displayNoteOctave">Select a note</div>
        </div>

        <svg class="sax-svg" viewBox="0 0 300 550" xmlns="http://www.w3.org/2000/svg">
            <!-- Definitions for gradients/filters -->
            <defs>
                <filter id="glowGold" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="4" result="blur" />
                    <feComposite in="SourceGraphic" in2="blur" operator="over" />
                </filter>
            </defs>

            <!-- Saxophone Body Outline (Stylized) -->
            <path class="sax-body" d="M 120 40 L 120 480 Q 120 520 150 520 Q 180 520 180 480 L 180 40" />

            <!-- === LEFT HAND (UPPER) === -->
            
            <!-- Octave Key -->
            <g transform="translate(150, 190)">
                <circle id="key-octave" class="key-shape" r="10" />
                <text class="key-label" y="1">OK</text>
            </g>

            <!-- Front F -->
            <g transform="translate(130, 110)">
                <circle id="key-frontF" class="key-shape" r="9" />
                <text class="key-label" y="1">X</text>
            </g>

            <!-- Palm Keys -->
            <g transform="translate(80, 100) rotate(-20)">
                <rect id="key-palmD" class="key-shape" width="30" height="15" rx="4" />
                <text class="key-label" x="15" y="8.5">D</text>
            </g>
            <g transform="translate(70, 80) rotate(-25)">
                <rect id="key-palmEb" class="key-shape" width="30" height="15" rx="4" />
                <text class="key-label" x="15" y="8.5">Eb</text>
            </g>
            <g transform="translate(60, 60) rotate(-30)">
                <rect id="key-palmF" class="key-shape" width="30" height="15" rx="4" />
                <text class="key-label" x="15" y="8.5">F</text>
            </g>

            <!-- Main Stack LH -->
            <g transform="translate(150, 100)">
                <circle id="key-lh1" class="key-shape" r="16" />
                <text class="key-label" y="1">1</text>
            </g>
            <g transform="translate(150, 128)">
                <circle id="key-bis" class="key-shape" r="9" />
                <text class="key-label" y="1">B</text>
            </g>
            <g transform="translate(150, 155)">
                <circle id="key-lh2" class="key-shape" r="16" />
                <text class="key-label" y="1">2</text>
            </g>
            <g transform="translate(150, 205)"> /* Lowered slightly to clear octave */
                <circle id="key-lh3" class="key-shape" r="16" />
                <text class="key-label" y="1">3</text>
            </g>

            <!-- LH Pinky Table -->
            <g transform="translate(100, 210)">
                <rect id="key-gSharp" class="key-shape" x="40" y="10" width="35" height="20" rx="3" />
                <text class="key-label" x="57.5" y="21">G#</text>
                
                <rect id="key-lowCSharp" class="key-shape" x="10" y="35" width="40" height="20" rx="3" />
                <text class="key-label" x="30" y="46">C#</text>
                
                <rect id="key-lowB" class="key-shape" x="5" y="60" width="40" height="20" rx="3" />
                <text class="key-label" x="25" y="71">B</text>
                
                <rect id="key-lowBb" class="key-shape" x="0" y="85" width="40" height="20" rx="3" />
                <text class="key-label" x="20" y="96">Bb</text>
            </g>

            <!-- === RIGHT HAND (LOWER) === -->
            
            <!-- Side Keys -->
            <g transform="translate(190, 120)">
                <rect id="key-highE" class="key-shape" x="0" y="0" width="15" height="30" rx="3" />
                <text class="key-label" x="7.5" y="16">C1</text>
                <rect id="key-sideC" class="key-shape" x="5" y="35" width="15" height="30" rx="3" />
                <text class="key-label" x="12.5" y="51">Tc</text>
                <rect id="key-sideBb" class="key-shape" x="10" y="70" width="15" height="30" rx="3" />
                <text class="key-label" x="17.5" y="86">Ta</text>
            </g>

            <!-- Main Stack RH -->
            <g transform="translate(0, 50)">
                <g transform="translate(150, 270)">
                    <circle id="key-rh4" class="key-shape" r="16" />
                    <text class="key-label" y="1">4</text>
                </g>
                <g transform="translate(150, 310)">
                    <circle id="key-rh5" class="key-shape" r="16" />
                    <text class="key-label" y="1">5</text>
                </g>
                <g transform="translate(150, 350)">
                    <circle id="key-rh6" class="key-shape" r="16" />
                    <text class="key-label" y="1">6</text>
                </g>
            </g>

            <!-- Side F# -->
            <g transform="translate(180, 330)">
                <rect id="key-sideFSharp" class="key-shape" width="15" height="30" rx="3" />
                <text class="key-label" x="7.5" y="16">Tf</text>
            </g>

            <!-- RH Pinky -->
            <g transform="translate(180, 410) rotate(10)">
                 <rect id="key-lowEb" class="key-shape" x="0" y="0" width="30" height="20" rx="4" />
                 <text class="key-label" x="15" y="11">Eb</text>
                 <rect id="key-lowC" class="key-shape" x="5" y="25" width="30" height="20" rx="4" />
                 <text class="key-label" x="20" y="36">C</text>
            </g>
        </svg>
    </div>

</div>

<script>
/**
 * DATA & CONSTANTS
 */
const NOTES_SHARP = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

const SCALES = {
    // Basic
    'Major': { intervals: [0, 2, 4, 5, 7, 9, 11], formula: '1 2 3 4 5 6 7' },
    'Natural Minor': { intervals: [0, 2, 3, 5, 7, 8, 10], formula: '1 2 b3 4 5 b6 b7' },
    'Harmonic Minor': { intervals: [0, 2, 3, 5, 7, 8, 11], formula: '1 2 b3 4 5 b6 7' },
    'Melodic Minor': { intervals: [0, 2, 3, 5, 7, 9, 11], formula: '1 2 b3 4 5 6 7' },
    // Pentatonic
    'Major Pentatonic': { intervals: [0, 2, 4, 7, 9], formula: '1 2 3 5 6' },
    'Minor Pentatonic': { intervals: [0, 3, 5, 7, 10], formula: '1 b3 4 5 b7' },
    'Dominant Pentatonic': { intervals: [0, 2, 4, 7, 10], formula: '1 2 3 5 b7' },
    'Blues Scale': { intervals: [0, 3, 5, 6, 7, 10], formula: '1 b3 4 b5 5 b7' },
    // Modes
    'Ionian': { intervals: [0, 2, 4, 5, 7, 9, 11], formula: '1 2 3 4 5 6 7' },
    'Dorian': { intervals: [0, 2, 3, 5, 7, 9, 10], formula: '1 2 b3 4 5 6 b7' },
    'Phrygian': { intervals: [0, 1, 3, 5, 7, 8, 10], formula: '1 b2 b3 4 5 b6 b7' },
    'Lydian': { intervals: [0, 2, 4, 6, 7, 9, 11], formula: '1 2 3 #4 5 6 7' },
    'Mixolydian': { intervals: [0, 2, 4, 5, 7, 9, 10], formula: '1 2 3 4 5 6 b7' },
    'Aeolian': { intervals: [0, 2, 3, 5, 7, 8, 10], formula: '1 2 b3 4 5 b6 b7' },
    'Locrian': { intervals: [0, 1, 3, 5, 6, 8, 10], formula: '1 b2 b3 4 b5 b6 b7' },
    // Jazz
    'Bebop Major': { intervals: [0, 2, 4, 5, 7, 8, 9, 11], formula: '1 2 3 4 5 #5 6 7' },
    'Bebop Dominant': { intervals: [0, 2, 4, 5, 7, 9, 10, 11], formula: '1 2 3 4 5 6 b7 7' },
    'Whole Tone': { intervals: [0, 2, 4, 6, 8, 10], formula: '1 2 3 #4 #5 b7' },
    'Altered': { intervals: [0, 1, 3, 4, 6, 8, 10], formula: '1 b2 #2 3 #4 #5 b7' },
    'Diminished (W-H)': { intervals: [0, 2, 3, 5, 6, 8, 9, 11], formula: '1 2 b3 4 b5 b6 6 7' },
    'Diminished (H-W)': { intervals: [0, 1, 3, 4, 6, 7, 9, 10], formula: '1 b2 b3 3 #4 5 6 b7' },
};

// Simplified standard saxophone fingerings
const SAX_FINGERINGS = {
    // Low Register
    'Bb3': ['lh1','lh2','lh3','gSharp','lowBb','rh4','rh5','rh6','lowC'],
    'A#3': ['lh1','lh2','lh3','gSharp','lowBb','rh4','rh5','rh6','lowC'],
    'B3':  ['lh1','lh2','lh3','lowB','rh4','rh5','rh6','lowC'],
    'C4':  ['lh1','lh2','lh3','rh4','rh5','rh6','lowC'],
    'C#4': ['lh1','lh2','lh3','lowCSharp','rh4','rh5','rh6','lowC'],
    'Db4': ['lh1','lh2','lh3','lowCSharp','rh4','rh5','rh6','lowC'],
    'D4':  ['lh1','lh2','lh3','rh4','rh5','rh6'],
    'D#4': ['lh1','lh2','lh3','rh4','rh5','rh6','lowEb'],
    'Eb4': ['lh1','lh2','lh3','rh4','rh5','rh6','lowEb'],
    'E4':  ['lh1','lh2','lh3','rh4','rh5'],
    'F4':  ['lh1','lh2','lh3','rh4'],
    'F#4': ['lh1','lh2','lh3','rh5'],
    'Gb4': ['lh1','lh2','lh3','rh5'],
    'G4':  ['lh1','lh2','lh3'],
    'G#4': ['lh1','lh2','lh3','gSharp'],
    'Ab4': ['lh1','lh2','lh3','gSharp'],
    'A4':  ['lh1','lh2'],
    'A#4': ['lh1','lh2','sideBb'],
    'Bb4': ['lh1','bis'], // Standard bis for scales
    'B4':  ['lh1'],
    'C5':  ['lh2'],
    'C#5': [],
    'Db5': [],
    
    // Middle/High (Octave Key ON)
    'D5':  ['octave','lh1','lh2','lh3','rh4','rh5','rh6'],
    'D#5': ['octave','lh1','lh2','lh3','rh4','rh5','rh6','lowEb'],
    'Eb5': ['octave','lh1','lh2','lh3','rh4','rh5','rh6','lowEb'],
    'E5':  ['octave','lh1','lh2','lh3','rh4','rh5'],
    'F5':  ['octave','lh1','lh2','lh3','rh4'],
    'F#5': ['octave','lh1','lh2','lh3','rh5'],
    'Gb5': ['octave','lh1','lh2','lh3','rh5'],
    'G5':  ['octave','lh1','lh2','lh3'],
    'G#5': ['octave','lh1','lh2','lh3','gSharp'],
    'Ab5': ['octave','lh1','lh2','lh3','gSharp'],
    'A5':  ['octave','lh1','lh2'],
    'A#5': ['octave','lh1','lh2','sideBb'],
    'Bb5': ['octave','lh1','bis'],
    'B5':  ['octave','lh1'],
    'C6':  ['octave','lh2'],
    'C#6': ['octave'],
    'Db6': ['octave'],
    'D6':  ['octave','palmD'],
    'D#6': ['octave','palmD','palmEb'],
    'Eb6': ['octave','palmD','palmEb'],
    'E6':  ['octave','palmD','palmEb','highE'],
    'F6':  ['octave','palmD','palmEb','palmF'],
    'F#6': ['octave','palmD','palmEb','palmF','sideFSharp'],
    'Gb6': ['octave','palmD','palmEb','palmF','sideFSharp']
};

/**
 * STATE
 */
const state = {
    instrument: 'ALTO',
    concertKey: 'C',
    scaleName: 'Major',
    scaleNotes: [], // Array of note objects {name, octave, isRoot}
    currentNoteIndex: -1, // -1 means none selected
    isPlaying: false
};

/**
 * MUSIC LOGIC
 */

function getNoteIndex(note) {
    const sharpIndex = NOTES_SHARP.indexOf(note);
    if (sharpIndex !== -1) return sharpIndex;
    return NOTES_FLAT.indexOf(note);
}

function getTransposedKey(concertKey, instrument) {
    const index = getNoteIndex(concertKey);
    let shift = (instrument === 'ALTO') ? 9 : 2; // Alto +9, Tenor +2
    const newIndex = (index + shift) % 12;
    
    // Heuristic for flats vs sharps
    const flatKeys = ['F', 'Bb', 'Eb', 'Ab', 'Db', 'Gb', 'Cb'];
    const isFlat = flatKeys.includes(concertKey) || 
                   (concertKey === 'C' && instrument === 'ALTO'); // C -> A major (sharps) actually.
                   // Wait, Concert C -> Alto A (3 sharps). Concert F -> Alto D (2 sharps).
                   // Concert Bb -> Alto G (1 sharp). Concert Eb -> Alto C.
                   // Concert Ab -> Alto F. Concert Db -> Alto Bb.
                   
    // Better heuristic: Map resulting key index to standard circle of fifths preference
    // 0(C), 1(Db/C#), 2(D), 3(Eb), 4(E), 5(F), 6(F#), 7(G), 8(Ab), 9(A), 10(Bb), 11(B)
    const preferFlats = [0, 5, 10, 3, 8, 1].includes(newIndex); // C, F, Bb, Eb, Ab, Db
    
    // Override logic to match common band keys
    const resultKeyFlat = NOTES_FLAT[newIndex];
    const resultKeySharp = NOTES_SHARP[newIndex];
    
    // Just stick to a simple mapping for this demo
    // If original key was flat, transposed tends to be flat unless we wrap around too much
    // Let's rely on standard Key signatures.
    const standardKeys = {
        'C': ['A', 'D'], // Concert C -> Alto A, Tenor D
        'F': ['D', 'G'],
        'Bb': ['G', 'C'],
        'Eb': ['C', 'F'],
        'Ab': ['F', 'Bb'],
        'Db': ['Bb', 'Eb'],
        'Gb': ['Eb', 'Ab'],
        'B': ['G#', 'C#'],
        'E': ['C#', 'F#'],
        'A': ['F#', 'B'],
        'D': ['B', 'E'],
        'G': ['E', 'A'],
        // Sharps
        'C#': ['A#', 'D#'],
        'F#': ['D#', 'G#'],
    };
    
    if (standardKeys[concertKey]) {
        return standardKeys[concertKey][instrument === 'ALTO' ? 0 : 1];
    }
    
    return preferFlats ? resultKeyFlat : resultKeySharp;
}

function generateScale(root, scaleName) {
    const def = SCALES[scaleName];
    if (!def) return [];

    const rootIndex = getNoteIndex(root);
    // Determine accidentals based on root
    const useSharps = !['C', 'F', 'Bb', 'Eb', 'Ab', 'Db', 'Gb'].includes(root);
    const noteArray = useSharps ? NOTES_SHARP : NOTES_FLAT;
    
    // Generate 2 Octaves of the scale
    // Start Octave approximation: 
    // Low register (Bb3 to C#4) -> Start 3
    // Mid register (D4 to C5) -> Start 4
    let startOctave = 4;
    const rootVal = getNoteIndex(root);
    if (rootVal >= 9) startOctave = 3; // A, Bb, B start low
    
    const intervals = [...def.intervals, ...def.intervals.map(i => i + 12)]; // 2 octaves
    
    const notes = [];
    
    intervals.forEach(interval => {
        const absIndex = rootIndex + interval;
        const noteIndex = absIndex % 12;
        const octaveShift = Math.floor(absIndex / 12);
        const octave = startOctave + octaveShift;
        
        // Range check (Bb3 to F#6)
        if (octave < 3) return;
        if (octave === 3 && noteIndex < 10) return; // Below Bb3
        if (octave > 6) return;
        if (octave === 6 && noteIndex > 6) return; // Above F#6

        notes.push({
            name: noteArray[noteIndex],
            octave: octave,
            isRoot: (interval % 12 === 0),
            id: `${noteArray[noteIndex]}${octave}`
        });
    });
    
    return notes;
}

/**
 * UI UPDATES
 */

function init() {
    // Populate Concert Keys
    const keySelect = document.getElementById('concertKeySelect');
    NOTES_FLAT.forEach(note => {
        // Use a mixed list for dropdown
        const opt = document.createElement('option');
        opt.value = note;
        opt.text = note;
        keySelect.appendChild(opt);
    });
    keySelect.value = 'C';

    // Event Listeners
    document.getElementById('instrumentSelect').addEventListener('change', (e) => {
        state.instrument = e.target.value;
        updateApp();
    });
    document.getElementById('concertKeySelect').addEventListener('change', (e) => {
        state.concertKey = e.target.value;
        updateApp();
    });
    document.getElementById('scaleTypeSelect').addEventListener('change', (e) => {
        state.scaleName = e.target.value;
        updateApp();
    });

    document.getElementById('prevBtn').addEventListener('click', () => stepNote(-1));
    document.getElementById('nextBtn').addEventListener('click', () => stepNote(1));
    document.getElementById('playBtn').addEventListener('click', togglePlay);

    // Initial Render
    updateApp();
}

function updateApp() {
    // 1. Calculate Keys
    const writtenKey = getTransposedKey(state.concertKey, state.instrument);
    document.getElementById('concertKeyDisplay').textContent = state.concertKey;
    document.getElementById('writtenKeyDisplay').textContent = writtenKey;
    
    const hint = state.instrument === 'ALTO' 
        ? "Alto Sax (Eb) sounds Major 6th higher than written (or Min 3rd lower)"
        : "Tenor Sax (Bb) sounds Major 9th higher than written (or Maj 2nd lower)";
    document.getElementById('transpositionHint').textContent = hint;

    // 2. Generate Scale
    document.getElementById('scaleFormulaDisplay').textContent = SCALES[state.scaleName].formula;
    state.scaleNotes = generateScale(writtenKey, state.scaleName);
    
    // 3. Render Note Grid
    renderNoteGrid();
    
    // 4. Reset Selection
    selectNote(0);
}

function renderNoteGrid() {
    const grid = document.getElementById('noteGrid');
    grid.innerHTML = '';
    
    state.scaleNotes.forEach((note, index) => {
        const btn = document.createElement('div');
        btn.className = `note-btn ${note.isRoot ? 'is-root' : 'is-note'}`;
        btn.textContent = note.name;
        // Tooltip for octave
        btn.title = `${note.name}${note.octave}`;
        
        btn.onclick = () => {
            stopPlay();
            selectNote(index);
        };
        
        grid.appendChild(btn);
    });
}

function selectNote(index) {
    if (index < 0 || index >= state.scaleNotes.length) return;
    
    state.currentNoteIndex = index;
    const note = state.scaleNotes[index];
    
    // Update Grid UI
    const buttons = document.querySelectorAll('.note-btn');
    buttons.forEach((b, i) => {
        if (i === index) b.classList.add('active');
        else b.classList.remove('active');
    });

    // Update Display Text
    document.getElementById('displayNoteName').textContent = note.name;
    document.getElementById('displayNoteOctave').textContent = `Octave ${note.octave}`;
    if (note.isRoot) {
        document.getElementById('displayNoteName').style.color = 'var(--accent-gold)';
    } else {
        document.getElementById('displayNoteName').style.color = 'var(--accent-blue)';
    }

    // Update Fingerings
    renderFingering(note);
}

function renderFingering(note) {
    // Clear all active keys
    document.querySelectorAll('.key-shape').forEach(el => {
        el.classList.remove('active-root', 'active-note');
    });

    // Lookup keys
    // Try exact match first, then enharmonic
    let keys = SAX_FINGERINGS[`${note.name}${note.octave}`];
    
    if (!keys) {
        // Try Enharmonic
        const idx = getNoteIndex(note.name);
        const altName = (NOTES_SHARP[idx] === note.name) ? NOTES_FLAT[idx] : NOTES_SHARP[idx];
        keys = SAX_FINGERINGS[`${altName}${note.octave}`];
    }

    if (keys) {
        const activeClass = note.isRoot ? 'active-root' : 'active-note';
        keys.forEach(keyId => {
            const el = document.getElementById(`key-${keyId}`);
            if (el) el.classList.add(activeClass);
        });
    }
}

function stepNote(direction) {
    stopPlay();
    let newIndex = state.currentNoteIndex + direction;
    if (newIndex < 0) newIndex = state.scaleNotes.length - 1;
    if (newIndex >= state.scaleNotes.length) newIndex = 0;
    selectNote(newIndex);
}

// Auto Play Logic
let playInterval = null;

function togglePlay() {
    if (state.isPlaying) {
        stopPlay();
    } else {
        startPlay();
    }
}

function startPlay() {
    state.isPlaying = true;
    document.getElementById('playBtn').textContent = 'Stop';
    document.getElementById('playBtn').style.background = 'var(--bg-panel)';
    
    let idx = state.currentNoteIndex;
    if (idx === -1) idx = 0;
    
    // Immediate first note
    selectNote(idx);

    playInterval = setInterval(() => {
        idx++;
        if (idx >= state.scaleNotes.length) {
            idx = 0; // Loop or stop? Let's loop
        }
        selectNote(idx);
    }, 600); // 600ms per note
}

function stopPlay() {
    state.isPlaying = false;
    document.getElementById('playBtn').textContent = 'Play Scale';
    document.getElementById('playBtn').style.background = ''; // reset
    if (playInterval) {
        clearInterval(playInterval);
        playInterval = null;
    }
}

// Start
init();

</script>
</body>
</html>